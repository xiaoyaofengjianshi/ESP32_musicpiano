/*
 * @file oled.c
 * @brief 2025科中考核SSD1306驱动的OLED文件
 * @author 何荣新
 * 
 * @details 本文件是字模存储与显示、菜单显示等OLED相关功能实现的核心部分。
 */

#include "oled.h"
#include <stdio.h>
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "driver/gpio.h"
#include "driver/spi_master.h"
#include "esp_log.h"
#include "led_strip.h"
#include "driver/ledc.h"
#include "esp_timer.h"
#include "esp_random.h" 
#include <math.h>
#include <string.h>
#include "global.h"

typedef enum {
    BORDER_NONE = 0,
    BORDER_DOT,      // 点阵流动边框
    BORDER_SPECTRUM, // 音乐频谱边框
    BORDER_COUNT
} border_type_t;

 border_type_t current_border = BORDER_DOT;
 border_type_t target_border = BORDER_DOT;
 border_type_t previous_border = BORDER_DOT;


 int64_t border_transition_start = 0;
 int BORDER_TRANSITION_DURATION = 500000; // 过渡持续时间
 bool border_in_transition = false;

// 点阵流动边框的变量
 int dot_pattern[16] = {1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1};
 int dot_offset = 0;
 int64_t last_dot_update = 0;
 int DOT_UPDATE_INTERVAL = 80; // 更新间隔

// 音乐频谱边框的变量
 int spectrum_bars[16] = {0};
 int64_t last_spectrum_update = 0;
 int SPECTRUM_UPDATE_INTERVAL = 100; // 更新间隔

/*音符名称显示控制*/
int current_note_display = -1;//当前显示的音符索引，-1表示不显示
int64_t note_display_start_time = 0;//音符显示开始时间
int NOTE_DISPLAY_DURATION = 500000;//音符显示持续时间，500ms，因为我们发声是500ms

 uint8_t oled_buffer[SSD1306_BUFFER_SIZE];//OLED预显示(缓冲区)


//按键到OLED显示音符名称的映射
int key_to_note_name[17] = {
    -1,//0: 未使用
    8,//1: Re# (D#4) -> #Re (索引8)
    1,//2: Re (D4) -> Re (索引1)
    7,//3: Do# (C#4) -> #Do (索引7)
    0,//4: Do (C4) -> Do (索引0)
    -1,//5: 音量增加/高音阶
    -1,//6: 亮度增加
    -1,//7: 音量减少/低音阶
    -1,//8: 亮度减少
    11,//9: So# (G#4) -> #So (索引11)
    5,//10: La (A4) -> La (索引5)
    12,//11: La# (A#4) -> #La (索引12) - 修正这里
    6,//12: Si (B4) -> Si (索引6)
    4,//13: So (G4) -> So (索引4)
    10,//14: Fa# (F#4) -> #Fa (索引10)
    3,//15: Fa (F4) -> Fa (索引3)
    2//16: Mi (E4) -> Mi (索引2)
};


//字模数据结构定义（16x16像素，32字节）
typedef struct {
    uint8_t data[32];//16x16点阵数据，按列行式排列
} CEChar16x16;

// 欢迎界面字模数据（128x64像素，1024字节）
uint8_t fullscreen_bitmap[SSD1306_BUFFER_SIZE] = {
    
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x80, 0xc0, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xff, 0x03, 0xfe, 0xfe, 0x7f, 0x3d, 0x1b, 0x3b, 0x36, 0x0e, 0x0c, 0x18, 0xf8, 0xfc, 0xfc, 0x3c, 0xfc, 
0xfc, 0xfc, 0x0c, 0xf8, 0xf8, 0x78, 0x0c, 0x0c, 0x06, 0x33, 0x3b, 0x3f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xf3, 0x3f, 0x00, 0x01, 0x01, 0x00, 0x00, 0xc0, 0xc0, 0xe0, 
0xe0, 0xe0, 0xe8, 0xc0, 0x83, 0x01, 0x00, 0x03, 0x07, 0x01, 0x00, 0x03, 0x81, 0xc8, 0xe0, 0xe0, 0xe0, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x01, 0x07, 
0x3f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x3f, 0xff, 0xfe, 
0xfe, 0xf6, 0x76, 0x56, 0x53, 0x07, 0x00, 0x07, 0x0f, 0x0f, 0x0f, 0x07, 0x03, 0x00, 0x20, 0x20, 0x34, 0x20, 0x20, 0x00, 0x07, 0x0f, 0x0f, 0x0f, 
0x0f, 0x07, 0x00, 0x17, 0x56, 0x76, 0x7e, 0xfe, 0xfe, 0xff, 0x7f, 0x1e, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x03, 0x83, 0xc6, 0x74, 0x3c, 0x9c, 0x88, 0x88, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x90, 0xb8, 0xb8, 0xb8, 0x3c, 0x7c, 0xe6, 0xc6, 0x03, 0x01, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xfe, 0xff, 0xe1, 0x60, 0xe0, 0xe0, 0xe0, 0xc0, 
0xf0, 0xf0, 0xfc, 0xf9, 0xff, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfb, 0xf9, 0xe1, 0xe1, 0xd1, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xff, 0xff, 
0xc0, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x0e, 0xfb, 0xc1, 0x81, 0x81, 0x83, 0xde, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x7f, 0xc1, 0x80, 0x00, 0x00, 
0x00, 0x01, 0x01, 0xa1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
0xff, 0xff, 0xff, 0xbf, 0xc1, 0xf1, 0xf0, 0xfc, 0xf8, 0xe4, 0xf9, 0xf1, 0xff, 0xfc, 0xff, 0xff, 0x7f, 0x3f, 0x1f, 0x0f, 0x03, 0x01, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x0f, 0x0d, 0x09, 0x09, 0x08, 0x08, 0x08, 0x0c, 0x0d, 0x0d, 0x0c, 0x0c, 
0x0c, 0x0c, 0x0c, 0x0c, 0x0b, 0x1b, 0x1b, 0x1b, 0x1e, 0x16, 0x16, 0x17, 0x17, 0x1f, 0x1f, 0x1f, 0x0f, 0x0f, 0x0f, 0x07, 0x0f, 0x0f, 0x0f, 0x0f, 
0x0f, 0x0f, 0x0f, 0x0f, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x07, 0x03, 0x03, 0x01, 0x01, 
0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 

};

//汉字字模数据
CEChar16x16 chinese_chars[] = {
//欢迎使用电子琴酱！
    {/* 0 欢 */ {0x04,0x24,0x44,0x84,0x64,0x9c,0x40,0x30,0x0f,0xc8,0x08,0x08,0x28,0x18,0x00,0x00,0x10,0x08,0x06,0x01,0x82,0x4c,0x20,0x18,0x06,0x01,0x06,0x18,0x20,0x40,0x80,0x00}},
    {/* 1 迎 */ {0x40,0x40,0x42,0xcc,0x00,0x00,0xfc,0x04,0x02,0x00,0xfc,0x04,0x04,0xfc,0x00,0x00,0x00,0x40,0x20,0x1f,0x20,0x40,0x4f,0x44,0x42,0x40,0x7f,0x42,0x44,0x43,0x40,0x00}},
    {/* 2 使 */ {0x80,0x60,0xf8,0x07,0x04,0xe4,0x24,0x24,0x24,0xff,0x24,0x24,0x24,0xe4,0x04,0x00,0x00,0x00,0xff,0x00,0x80,0x81,0x45,0x29,0x11,0x2f,0x41,0x41,0x81,0x81,0x80,0x00}},
    {/* 3 用 */ {0x00,0x00,0xfe,0x22,0x22,0x22,0x22,0xfe,0x22,0x22,0x22,0x22,0xfe,0x00,0x00,0x00,0x80,0x60,0x1f,0x02,0x02,0x02,0x02,0x7f,0x02,0x02,0x42,0x82,0x7f,0x00,0x00,0x00}},
    {/* 4 电 */ {0x00,0x00,0xf8,0x88,0x88,0x88,0x88,0xff,0x88,0x88,0x88,0x88,0xf8,0x00,0x00,0x00,0x00,0x00,0x1f,0x08,0x08,0x08,0x08,0x7f,0x88,0x88,0x88,0x88,0x9f,0x80,0xf0,0x00}},
    {/* 5 子 */ {0x80,0x82,0x82,0x82,0x82,0x82,0x82,0xe2,0xa2,0x92,0x8a,0x86,0x82,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x80,0x7f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {/* 6 琴 */ {0x82,0x92,0x92,0xfe,0x92,0x92,0x82,0x00,0x82,0x92,0x92,0xfe,0x92,0x92,0x82,0x00,0x08,0x08,0x08,0x14,0x14,0x12,0x16,0x99,0x52,0x32,0x14,0x04,0x08,0x08,0x08,0x00}},
    {/* 7 酱 */ {0xa0,0xa2,0x94,0x88,0xff,0x80,0x88,0xa4,0xa6,0xad,0x94,0x94,0x8c,0x84,0x80,0x00,0x00,0x00,0xfe,0xb2,0xaa,0xa7,0xa2,0xa2,0xa7,0xaa,0xaa,0xaa,0xfe,0x00,0x00,0x00}},
    {/* 8 ！ */ {0x00,0x00,0x00,0x00,0x00,0x7c,0xfe,0x7c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x3b,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
    {/* 9 小 */ {0x00,0x00,0x00,0xe0,0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x20,0x40,0x80,0x00,0x00,0x08,0x04,0x03,0x00,0x00,0x40,0x80,0x7f,0x00,0x00,0x00,0x00,0x00,0x01,0x0e,0x00}},
    {/* 10 星 */ {0x00,0x00,0x00,0xbe,0x2a,0x2a,0x2a,0xea,0x2a,0x2a,0x2a,0x3e,0x00,0x00,0x00,0x00,0x00,0x44,0x42,0x49,0x49,0x49,0x49,0x7f,0x49,0x49,0x49,0x49,0x41,0x40,0x00,0x00}},
    {/* 11 天 */ {0x40,0x40,0x42,0x42,0x42,0x42,0x42,0xfe,0x42,0x42,0x42,0x42,0x42,0x40,0x40,0x00,0x80,0x80,0x40,0x20,0x10,0x0c,0x03,0x00,0x03,0x0c,0x10,0x20,0x40,0x80,0x80,0x00}},
    {/* 12 下 */ {0x02,0x02,0x02,0x02,0x02,0x02,0xfe,0x02,0x02,0x42,0x82,0x02,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x01,0x06,0x00,0x00,0x00}},
    {/* 13 相 */ {0x10,0x10,0x10,0xd0,0xff,0x90,0x10,0x00,0xfe,0x22,0x22,0x22,0x22,0xfe,0x00,0x00,0x08,0x04,0x03,0x00,0xff,0x00,0x03,0x00,0xff,0x42,0x42,0x42,0x42,0xff,0x00,0x00}},
    {/* 14 亲 */ {0x40,0x40,0x44,0x44,0x54,0x64,0x45,0xc6,0x44,0x64,0x54,0x44,0x44,0x40,0x40,0x00,0x00,0x42,0x22,0x12,0x0a,0x42,0x82,0x7f,0x02,0x02,0x0a,0x12,0x22,0x42,0x00,0x00}},
    {/* 15 与 */ {0x00,0x00,0xe0,0x9f,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x08,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x48,0x80,0x40,0x3f,0x00,0x00,0x00}},
    {/* 16 爱 */ {0x80,0x64,0x2c,0x34,0x24,0x24,0xec,0x32,0x22,0x22,0x32,0x2e,0x23,0xa2,0x60,0x00,0x00,0x41,0x21,0x91,0x89,0x87,0x4d,0x55,0x25,0x25,0x55,0x4d,0x81,0x80,0x80,0x00}},
    {/* 17 升 */ {0x80,0x80,0x84,0x84,0x84,0xfe,0x82,0x83,0x82,0x80,0xff,0x80,0x80,0x80,0x80,0x00,0x00,0x80,0x40,0x20,0x18,0x07,0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x00,0x00,0x00,}},
    {/* 18 调 */ {0x40,0x42,0xcc,0x00,0x00,0xfe,0x82,0x92,0x92,0xfe,0x92,0x92,0x82,0xfe,0x00,0x00,0x00,0x00,0x3f,0x10,0x88,0x7f,0x00,0x1e,0x12,0x12,0x12,0x5e,0x80,0x7f,0x00,0x00,}},
    {/* 19 降 */ {0x00,0xfe,0x02,0x22,0xda,0x86,0x90,0x48,0x57,0x24,0xa4,0x54,0x4c,0x84,0x80,0x00,0x00,0xff,0x08,0x10,0x08,0x07,0x18,0x12,0x12,0x12,0xff,0x12,0x12,0x12,0x10,0x00,}},
    {/* 20 触 */ {0x10,0xec,0x27,0xf4,0x2c,0xe0,0x00,0xf8,0x08,0x08,0xff,0x08,0x08,0xf8,0x00,0x00,0x80,0x7f,0x09,0x3f,0x89,0xff,0x20,0x63,0x21,0x21,0x3f,0x21,0x29,0x33,0x60,0x00,}},
    {/* 21 摸 */ {0x10,0x10,0x10,0xff,0x10,0x94,0xe4,0xaf,0xa4,0xa4,0xa4,0xaf,0xe4,0x04,0x00,0x00,0x04,0x44,0x82,0x7f,0x01,0x88,0x4b,0x2a,0x1a,0x0e,0x1a,0x2a,0x4b,0x88,0x80,0x00,}},
    {/* 22 键 */ {0x40,0x30,0xef,0x24,0x24,0x80,0xe4,0x9c,0x10,0x54,0x54,0xff,0x54,0x7c,0x10,0x00,0x01,0x01,0x7f,0x21,0x51,0x26,0x18,0x27,0x44,0x45,0x45,0x5f,0x45,0x45,0x44,0x00,}},
    {/* 23 播 */ {0x10,0x10,0xff,0x10,0x90,0x82,0x56,0x3a,0x12,0x7f,0x11,0x39,0x55,0x90,0x80,0x00,0x42,0x82,0x7f,0x01,0x00,0x00,0xff,0x49,0x49,0x7f,0x49,0x49,0xff,0x00,0x00,0x00,}},
    {/* 24 放 */ {0x08,0x08,0xf9,0x4a,0x48,0xc8,0x48,0x20,0xd8,0x17,0x10,0x10,0xf0,0x10,0x10,0x00,0x40,0x30,0x0f,0x20,0x40,0x3f,0x80,0x40,0x21,0x16,0x08,0x16,0x21,0x40,0x80,0x00,}},
    {/* 25 音 */ {0x40,0x40,0x44,0x44,0x54,0x64,0x45,0x46,0x44,0x64,0x54,0x44,0x44,0x40,0x40,0x00,0x00,0x00,0x00,0xff,0x49,0x49,0x49,0x49,0x49,0x49,0x49,0xff,0x00,0x00,0x00,0x00,}},
    {/* 26 符 */ {0x10,0x08,0x04,0x87,0x6c,0x14,0x84,0x94,0x88,0x87,0x84,0xec,0x94,0x84,0x84,0x00,0x04,0x02,0x01,0xff,0x00,0x00,0x00,0x02,0x0c,0x40,0x80,0x7f,0x00,0x00,0x00,0x00,}},  
    {/* 27 按 */ {0x10,0x10,0x10,0xff,0x90,0x20,0x98,0x88,0x88,0xe9,0x8e,0x88,0x88,0xa8,0x98,0x00,0x02,0x42,0x81,0x7f,0x00,0x00,0x80,0x84,0x4b,0x28,0x10,0x28,0x47,0x80,0x00,0x00,}},
    {/* 28 住 */ {0x00,0x80,0x60,0xf8,0x07,0x08,0x08,0x08,0x09,0xfa,0x08,0x08,0x08,0x08,0x00,0x00,0x01,0x00,0x00,0xff,0x40,0x41,0x41,0x41,0x41,0x7f,0x41,0x41,0x41,0x41,0x40,0x00,}},
    {/* 29 暂 */ {0x82,0x9a,0x96,0x93,0xfa,0x52,0x52,0x80,0x7e,0x12,0x12,0x12,0xf1,0x11,0x10,0x00,0x00,0x01,0x00,0xfe,0x93,0x92,0x93,0x92,0x92,0x92,0x92,0xfe,0x03,0x00,0x00,0x00,}},
    {/* 30 停 */ {0x80,0x60,0xf8,0x07,0x00,0x04,0x74,0x54,0x55,0x56,0x54,0x54,0x74,0x04,0x00,0x00,0x00,0x00,0xff,0x00,0x03,0x01,0x05,0x45,0x85,0x7d,0x05,0x05,0x05,0x01,0x03,0x00,}},
    {/* 31 亮 */ {0x00,0x04,0x04,0x74,0x54,0x54,0x55,0x56,0x54,0x54,0x54,0x74,0x04,0x04,0x00,0x00,0x84,0x83,0x41,0x21,0x1d,0x05,0x05,0x05,0x05,0x05,0x7d,0x81,0x81,0x85,0xe3,0x00,}},
    {/* 32 度 */ {0x00,0x00,0xfc,0x24,0x24,0x24,0xfc,0x25,0x26,0x24,0xfc,0x24,0x24,0x24,0x04,0x00,0x40,0x30,0x8f,0x80,0x84,0x4c,0x55,0x25,0x25,0x25,0x55,0x4c,0x80,0x80,0x80,0x00,}},
    {/* 33 节 */ {0x04,0x44,0x44,0x44,0x5f,0x44,0xc4,0x44,0x44,0x44,0x5f,0x44,0xc4,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,0x00,0x08,0x10,0x08,0x07,0x00,0x00,0x00,}},
    {/* 34 变 */ {0x04,0x44,0x24,0x14,0x04,0x7c,0x05,0x06,0x04,0x7c,0x04,0x14,0x24,0x44,0x04,0x00,0x80,0x80,0x81,0x41,0x43,0x25,0x29,0x11,0x29,0x25,0x43,0x41,0x80,0x80,0x80,0x00,}},
    {/* 35 亮 */ {0x00,0x04,0x04,0x74,0x54,0x54,0x55,0x56,0x54,0x54,0x54,0x74,0x04,0x04,0x00,0x00,0x84,0x83,0x41,0x21,0x1d,0x05,0x05,0x05,0x05,0x05,0x7d,0x81,0x81,0x85,0xe3,0x00,}},
    {/* 36 暗 */ {0x00,0xfc,0x84,0x84,0xfc,0x40,0x44,0x54,0x65,0x46,0x44,0x64,0x54,0x44,0x40,0x00,0x00,0x3f,0x10,0x10,0x3f,0x00,0x00,0xff,0x49,0x49,0x49,0x49,0xff,0x00,0x00,0x00,}},
    {/* 37 量 */ {0x20,0x20,0x20,0xbe,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xaa,0xbe,0x20,0x20,0x20,0x00,0x00,0x80,0x80,0xaf,0xaa,0xaa,0xaa,0xff,0xaa,0xaa,0xaa,0xaf,0x80,0x80,0x00,0x00,}}
};

//英文字母字模数据（16x16像素）
CEChar16x16 english_chars[] = {
    {/* 0 D */ {0xf8,0x08,0x08,0x08,0x08,0x08,0x30,0xc0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x20,0x20,0x20,0x20,0x20,0x18,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 1 o */ {0x00,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x10,0x20,0x20,0x20,0x10,0x0f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 2 R */ {0xf8,0x08,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x01,0x01,0x01,0x01,0x06,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 3 e */ {0x00,0x80,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x12,0x22,0x22,0x22,0x22,0x13,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 4 M */ {0xf8,0x18,0x60,0x80,0x00,0x00,0x00,0x80,0x60,0x18,0xf8,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x01,0x06,0x18,0x06,0x01,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x00,}},
    {/* 5 i */ {0x40,0xd8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 6 F */ {0xf8,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 7 a */ {0x80,0x40,0x40,0x40,0x40,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1c,0x22,0x22,0x22,0x12,0x1f,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 8 S */ {0x60,0x90,0x08,0x08,0x08,0x08,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x20,0x21,0x21,0x21,0x12,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 9 L */ {0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x20,0x20,0x20,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 10 X */{0x08,0x10,0x20,0x40,0x80,0x40,0x20,0x10,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x10,0x08,0x06,0x01,0x06,0x08,0x10,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 11 # */ {0x00,0x20,0xe0,0x3c,0x20,0xe0,0x3c,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x3c,0x07,0x04,0x3c,0x07,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 12 3 */ {0x00,0x10,0x08,0x08,0x08,0x08,0x90,0x60,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x20,0x21,0x21,0x21,0x12,0x0c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 13 4 */ {0x00,0x00,0x80,0x40,0x20,0x10,0xf8,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x05,0x04,0x04,0x04,0x3f,0x04,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 14 5 */ {0x00,0xf8,0x88,0x88,0x88,0x88,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x20,0x20,0x20,0x20,0x11,0x0e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 15 C */ {0xc0,0x30,0x08,0x08,0x08,0x08,0x08,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x18,0x20,0x20,0x20,0x20,0x20,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 16 : */ {0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 17 B */ {0xf8,0x08,0x08,0x08,0x08,0x88,0x70,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x21,0x21,0x21,0x21,0x22,0x1c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 18 E */ {0xf8,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3f,0x21,0x21,0x21,0x21,0x21,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 19 < */ {0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x40,0x40,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x06,0x09,0x09,0x10,0x20,0x20,0x40,0x40,0x00,0x00,0x00,0x00,0x00,}},
    {/* 20 — */ {0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 21 A */ {0x00,0x00,0x80,0x60,0x18,0x60,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x0e,0x03,0x02,0x02,0x02,0x03,0x0e,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x00,}},
    {/* 22 > */ {0x00,0x20,0x40,0x40,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x40,0x20,0x20,0x10,0x11,0x09,0x0a,0x06,0x04,0x00,0x00,0x00,0x00,0x00,}}

};


//音符名称的英文字母索引
int note_name_english[14][3] = {
//基本音符
    {0, 1, -1},//0:Do
    {2, 3, -1},//1:Re 
    {4, 5, -1},//2:Mi
    {6, 7, -1},//3:Fa
    {8, 1, -1},//4:So
    {9, 7, -1},//5:La
    {8, 5, -1},//6:Si
//带升号的
    {11, 0, 1},//7:#Do
    {11, 2, 3},//8:#Re
    {11, 4, 5},//9:#Mi
    {11, 6, 7},//10:#Fa
    {11, 8, 1},//11:#So
    {11, 9, 7},//12:#La
    {11, 8, 5}//13:#Si
};


/*SPI初始化*/
esp_err_t spi_init(void)
{
    //ESP_LOGI(TAG, "Initializing SPI bus");
    
//配置GPIO引脚
    gpio_config_t io_conf = {
        .pin_bit_mask = (1ULL << DC_GPIO) | (1ULL << RESET_GPIO),
        .mode = GPIO_MODE_OUTPUT,
        .pull_up_en = GPIO_PULLUP_DISABLE,
        .pull_down_en = GPIO_PULLDOWN_DISABLE,//用不到上下拉
        .intr_type = GPIO_INTR_DISABLE,
    };
    ESP_ERROR_CHECK(gpio_config(&io_conf));
    
//配置SPI总线
    spi_bus_config_t bus_config = {
        .miso_io_num = -1,//实则我们没有MISO
        .mosi_io_num = SPI_MOSI_GPIO,
        .sclk_io_num = SPI_CLK_GPIO,
        .quadwp_io_num = -1,
        .quadhd_io_num = -1,//这俩我们没有
        .max_transfer_sz = SSD1306_BUFFER_SIZE + 2,//预留两个字节防崩溃
    };
    
//初始化SPI总线
    ESP_ERROR_CHECK(spi_bus_initialize(MY_SPI_HOST, &bus_config, SPI_DMA_CH_AUTO));//查的网上，复制粘贴过来没问题
    
//配置SPI设备
    spi_device_interface_config_t dev_config = {
        .command_bits = 0,
        .address_bits = 0,
        .dummy_bits = 0,
        .mode = 0,//SPI mode 0
        .clock_speed_hz = 10 * 1000 * 1000,//10MHz
        .spics_io_num = SPI_CS_GPIO,
        .queue_size = 7,
    };
    
//添加SPI设备
    ESP_ERROR_CHECK(spi_bus_add_device(MY_SPI_HOST, &dev_config, &spi));
    
    ESP_LOGI(TAG, "SPI initialized successfully");
    return ESP_OK;
}


//写入数据
 esp_err_t ssd1306_write_data(uint8_t *data, size_t len)
{
    esp_err_t ret;
    spi_transaction_t t;
    memset(&t, 0, sizeof(t));
    
//设置DC引脚为高电平（数据模式）
    gpio_set_level(DC_GPIO, 1);
    
    t.length = len * 8;//数据长度（位）
    t.tx_buffer = data;//数据缓冲区
    
    ret = spi_device_polling_transmit(spi, &t);
    
    return ret;
}



//硬件复位
 void ssd1306_reset(void)
{
    gpio_set_level(RESET_GPIO, 0);
    vTaskDelay(pdMS_TO_TICKS(10));
    gpio_set_level(RESET_GPIO, 1);
    vTaskDelay(pdMS_TO_TICKS(10));
}


//写入命令
 esp_err_t ssd1306_write_command(uint8_t command)
{
    esp_err_t ret;//错误处理
    spi_transaction_t t;//单次SPI传输的所有参数
    memset(&t, 0, sizeof(t));//似乎确实要先把所有东西都移走
    
//设置DC引脚为低电平（命令模式）
    gpio_set_level(DC_GPIO, 0);
    
    t.length = 8;//命令长度为8位
    t.tx_buffer = &command;//命令数据
    
    ret = spi_device_polling_transmit(spi, &t);
    
    return ret;
}

//初始化SSD1306
esp_err_t ssd1306_init(void)
{
    //ESP_LOGI(TAG, "Initializing SSD1306 display");
    
//硬件复位
    ssd1306_reset();
    
//SSD1306初始化命令序列(搬的网上的)
    uint8_t init_commands[] = {
        0xAE,//Display OFF
        0xD5, 0x80,//Set display clock divide ratio/oscillator frequency
        0xA8, 0x3F,//Set multiplex ratio (1 to 64)
        0xD3, 0x00,//Set display offset
        0x40,//Set display start line
        0x8D, 0x14,//Charge pump setting
        0x20, 0x00,//Set memory addressing mode
        0xA1,//Segment remap
        0xC8,//COM output scan direction
        0xDA, 0x12,//Set COM pins hardware configuration
        0x81, 0xCF,//Set contrast control
        0xD9, 0xF1,//Set pre-charge period
        0xDB, 0x40,//Set VCOMH deselect level
        0xA4,//Entire display ON
        0xA6,//Set normal display
        0xAF//Display ON
    };
    
//发送初始化命令序列
    for (size_t i = 0; i < sizeof(init_commands); i++) {
        esp_err_t ret = ssd1306_write_command(init_commands[i]);
        if (ret != ESP_OK) {
            ESP_LOGE(TAG, "Failed to send init command: 0x%02x", init_commands[i]);
            return ret;
        }
    }
    
//清空显示缓冲区
    memset(oled_buffer, 0, SSD1306_BUFFER_SIZE);
    
    ESP_LOGI(TAG, "SSD1306 initialized successfully");
    return ESP_OK;
}

//清屏
esp_err_t ssd1306_clear_screen(uint8_t color)
{
    memset(oled_buffer, color ? 0xFF : 0x00, SSD1306_BUFFER_SIZE);
    return ESP_OK;
}


//刷新显示
esp_err_t ssd1306_refresh_gram(void)
{
//设置列地址范围为0-127
    ssd1306_write_command(0x21);
    ssd1306_write_command(0x00);
    ssd1306_write_command(0x7F);
    
//设置页地址范围为0-7
    ssd1306_write_command(0x22);
    ssd1306_write_command(0x00);
    ssd1306_write_command(0x07);
    
//写入整个显示缓冲区
    return ssd1306_write_data(oled_buffer, SSD1306_BUFFER_SIZE);
}



/**
 * @brief 最简单的全屏字模显示函数
 * @param bitmap_data 字模数据指针（1024字节）
 * @return esp_err_t 执行结果
 */
esp_err_t display_fullscreen_simple(uint8_t *bitmap_data) {
    if (bitmap_data == NULL) {
        //ESP_LOGE(TAG, "字模数据为空指针");
        return ESP_ERR_INVALID_ARG;
    }
    
    // 直接内存拷贝
    memcpy(oled_buffer, bitmap_data, SSD1306_BUFFER_SIZE);
    
    // 刷新到OLED屏幕
    return ssd1306_refresh_gram();
}

//OLED初始化函数
void init_oled() {
//初始化SPI总线
    if (spi_init() != ESP_OK) {
        //printf("SPI initialization failed!\n");
        return;
    }
    
//初始化OLED
    if (ssd1306_init() != ESP_OK) {
        //printf("SSD1306 initialization failed!\n");
        return;
    }
    
//清屏并显示初始信息
    ssd1306_clear_screen(0x00);
    ssd1306_refresh_gram();
    //printf("OLED initialized successfully!\n");
    
    
}

 int current_animation_frame = 0;//现在哪一帧动画
 int64_t last_frame_time = 0;
 int FRAME_DELAY_MS = 200;//每帧200ms

//简单的音符图标帧数据（8x8像素，ai）
 uint8_t music_icon_frames[4][8] = {
    {0x18, 0x1C, 0x1E, 0x1F, 0x1F, 0x0E, 0x04, 0x00},
    {0x0C, 0x1E, 0x1F, 0x1F, 0x1F, 0x0E, 0x04, 0x00},
    {0x06, 0x0F, 0x1F, 0x1F, 0x1F, 0x0E, 0x04, 0x00},
    {0x03, 0x07, 0x0F, 0x1F, 0x1F, 0x0E, 0x04, 0x00}
};


//更新动画帧
void update_animation_frame() {
    int64_t current_time = esp_timer_get_time();
    if (current_time - last_frame_time > FRAME_DELAY_MS * 1000) {
        current_animation_frame = (current_animation_frame + 1) % 4;
        last_frame_time = current_time;
    }
}


//绘制像素点
esp_err_t ssd1306_draw_pixel(uint8_t x, uint8_t y, uint8_t color)
{
    if (x >= SSD1306_WIDTH || y >= SSD1306_HEIGHT) {
        return ESP_ERR_INVALID_ARG;
    }
    
//计算像素在缓冲区中的位置
    uint16_t index = x + (y / 8) * SSD1306_WIDTH;
    if (color == 1) {//白色
        oled_buffer[index] |= (1 << (y % 8));
    } else {//黑色
        oled_buffer[index] &= ~(1 << (y % 8));
    }
    
    return ESP_OK;
}


//显示单个英文字母（16x16像素）
void ssd1306_draw_english_char(uint8_t x, uint8_t y, int char_index, uint8_t color) {
    CEChar16x16 *char_data = &english_chars[char_index];
    
//列行式：每列2字节，共16列
    for (int col = 0; col < 16; col++) {
//获取当前列的2个字节
        uint8_t byte1 = char_data->data[col];//第一字节
        uint8_t byte2 = char_data->data[col + 16];//第二字节
        
//绘制第一字节的8个像素（0-7行）
        for (int bit = 0; bit < 8; bit++) {
            if (byte1 & (1 << bit)) {//从低位到高位（LSB在前）
                ssd1306_draw_pixel(x + col, y + bit, color);
            }
        }
        
//绘制第二字节的8个像素（8-15行）
        for (int bit = 0; bit < 8; bit++) {
            if (byte2 & (1 << bit)) {//从低位到高位（LSB在前）
                ssd1306_draw_pixel(x + col, y + bit + 8, color);
            }
        }
    }
}

//绘制音符图标,xy分别是其左上角坐标
void draw_music_note_icon(uint8_t x, uint8_t y) {
    uint8_t *icon = music_icon_frames[current_animation_frame];
    for (int i = 0; i < 8; i++) {
        uint8_t line = icon[i];
        for (int j = 0; j < 8; j++) {
            if (line & (1 << j)) {
                ssd1306_draw_pixel(x + j, y + i, 1);
            }
        }
    }
}

//音符动画结构体
typedef struct {
    bool active;//是否激活
    float x;//当前x坐标
    float y;//当前y坐标
    float speed;//上升速度
    float size;//音符大小
    int64_t start_time;//动画开始时间
    int frame;//当前动画帧
} FloatingNote;
 FloatingNote floating_notes[MAX_FLOATING_NOTES] = {0};

//绘制音符动画
void draw_floating_notes(void) {
    for (int i = 0; i < MAX_FLOATING_NOTES; i++) {
        if (floating_notes[i].active) {
//获取当前帧的音符图标
            uint8_t *icon = music_icon_frames[floating_notes[i].frame];
            
//计算实际位置
            int x = (int)floating_notes[i].x;
            int y = (int)floating_notes[i].y;
            
//画
            for (int row = 0; row < 8; row++) {
                uint8_t line = icon[row];
                for (int col = 0; col < 8; col++) {
                    if (line & (1 << col)) {
                        int px = x + col;
                        int py = y + row;
                        
//确保在屏幕范围内
                        if (px >= 0 && px < SSD1306_WIDTH && py >= 0 && py < SSD1306_HEIGHT) {
                            ssd1306_draw_pixel(px, py, 1);
                        }
                    }
                }
            }
            
            //ESP_LOGI(TAG, "绘制音符 %d: 位置(%d, %d)", i, x, y);
        }
    }
}

/**
 * @brief 绘制进度条
 * 
 * @param x 左上角的x坐标
 * @param y 左上角的y坐标
 * @param width 进度条宽度
 * @param height 进度条高度
 * @param progress 进度值（0.0-1.0）
 */
void draw_progress_bar(uint8_t x, uint8_t y, uint8_t width, uint8_t height, float progress) {
//绘制边框
    for (int i = x; i < x + width; i++) {
        ssd1306_draw_pixel(i, y, 1);//上边框
        ssd1306_draw_pixel(i, y + height - 1, 1);//下边框
    }
    for (int i = y; i < y + height; i++) {
        ssd1306_draw_pixel(x, i, 1);//左边框
        ssd1306_draw_pixel(x + width - 1, i, 1);//右边框
    }
    
//计算填充宽度
    uint8_t fill_width = (uint8_t)((width - 2) * progress);//为什么要-2？因为边框占2个像素
    if (fill_width > 0) {
//绘制填充部分
        for (int i = x + 1; i < x + 1 + fill_width; i++) {
            for (int j = y + 1; j < y + height - 1; j++) {
                ssd1306_draw_pixel(i, j, 1);
            }
        }
    }
}



//显示单个汉字
void ssd1306_draw_chinese_char(uint8_t x, uint8_t y, int char_index, uint8_t color) {
    
    CEChar16x16 *char_data = &chinese_chars[char_index];
    
//列行式
    for (int col = 0; col < 16; col++) {
//获取当前列的2个字节
        uint8_t byte1 = char_data->data[col];//第一字节
        uint8_t byte2 = char_data->data[col + 16];//第二字节
        
//绘制第一字节
        for (int bit = 0; bit < 8; bit++) {
            if (byte1 & (1 << bit)) {//从低位到高位（LSB在前最右）
                ssd1306_draw_pixel(x + col, y + bit, color);
            }
        }
        
//第二字节
        for (int bit = 0; bit < 8; bit++) {
            if (byte2 & (1 << bit)) {
                ssd1306_draw_pixel(x + col, y + bit + 8, color);
            }
        }
    }
}

// 音乐频谱边框绘制函数
void draw_spectrum_border(float intensity) {
    if (intensity <= 0.0f) return;
    
    int64_t current_time = esp_timer_get_time();
    if (current_time - last_spectrum_update < SPECTRUM_UPDATE_INTERVAL * 1000) {
        return;
    }
    last_spectrum_update = current_time;
    
    // 根据播放状态更新频谱
    if (is_playing_song || single_note_playing) {
        for (int i = 0; i < 16; i++) {
            int base_height;
            if (i < 4 || i > 11) {
                base_height = (esp_random() % 2) + 1; // 低频和高频较低
            } else if (i < 6 || i > 9) {
                base_height = (esp_random() % 3) + 2; // 中低频和中高频中等
            } else {
                base_height = (esp_random() % 4) + 3; // 中频较高
            }
            spectrum_bars[i] = base_height;
        }
    } else {
        for (int i = 0; i < 16; i++) {
            spectrum_bars[i] = (esp_random() % 2);
        }
    }
    
    // 根据强度调整频谱高度
    for (int i = 0; i < 16; i++) {
        int adjusted_height = (int)(spectrum_bars[i] * intensity);
        if (adjusted_height < 1) adjusted_height = 1;
        
        int bar_start = i * 8;
        for (int j = 0; j < adjusted_height; j++) {
            if (bar_start + j < SSD1306_WIDTH) {
                ssd1306_draw_pixel(bar_start + j, 0, 1);
                ssd1306_draw_pixel(bar_start + j, SSD1306_HEIGHT - 1, 1);
            }
        }
    }
}

// 自动选择边框类型
border_type_t auto_select_border() {
    if (is_playing_song || single_note_playing) {
        return BORDER_SPECTRUM; // 播放时使用音乐频谱边框
    } else {
        return BORDER_DOT; // 未播放时使用点阵流动边框
    }
}

void draw_dot_border(float intensity) {
    if (intensity <= 0.0f) return;
    
    int64_t current_time = esp_timer_get_time();
    if (current_time - last_dot_update < DOT_UPDATE_INTERVAL * 1000) {
        return;
    }
    last_dot_update = current_time;
    
    dot_offset = (dot_offset + 1) % 16;
    
    // 根据强度计算要绘制的点数
    int dots_to_draw = (int)(16 * intensity);
    if (dots_to_draw < 1) dots_to_draw = 1;
    
    // 绘制上边框点阵（修复边界检查）
    for (int i = 0; i < dots_to_draw; i++) {
        int pattern_index = (dot_offset + i) % 16;
        if (dot_pattern[pattern_index]) {
            int x = (i * 8) % SSD1306_WIDTH;
            // 确保x+1不越界
            if (x < SSD1306_WIDTH) {
                ssd1306_draw_pixel(x, 0, 1);
            }
            if (x + 1 < SSD1306_WIDTH) {
                ssd1306_draw_pixel(x + 1, 0, 1);
            }
        }
    }
    
    // 绘制下边框点阵（修复边界检查）
    for (int i = 0; i < dots_to_draw; i++) {
        int pattern_index = (dot_offset + i + 8) % 16;
        if (dot_pattern[pattern_index]) {
            int x = (i * 8) % SSD1306_WIDTH;
            // 确保x+1不越界
            if (x < SSD1306_WIDTH) {
                ssd1306_draw_pixel(x, SSD1306_HEIGHT - 1, 1);
            }
            if (x + 1 < SSD1306_WIDTH) {
                ssd1306_draw_pixel(x + 1, SSD1306_HEIGHT - 1, 1);
            }
        }
    }
    
    // 绘制左边框点阵（修复边界检查）
    for (int i = 0; i < dots_to_draw; i++) {
        int pattern_index = (dot_offset + i + 4) % 16;
        if (dot_pattern[pattern_index]) {
            int y = (i * 4) % SSD1306_HEIGHT;
            // 确保y+1不越界
            if (y < SSD1306_HEIGHT) {
                ssd1306_draw_pixel(0, y, 1);
            }
            if (y + 1 < SSD1306_HEIGHT) {
                ssd1306_draw_pixel(0, y + 1, 1);
            }
        }
    }
    
    // 绘制右边框点阵（修复边界检查）
    for (int i = 0; i < dots_to_draw; i++) {
        int pattern_index = (dot_offset + i + 12) % 16;
        if (dot_pattern[pattern_index]) {
            int y = (i * 4) % SSD1306_HEIGHT;
            // 确保y+1不越界
            if (y < SSD1306_HEIGHT) {
                ssd1306_draw_pixel(SSD1306_WIDTH - 1, y, 1);
            }
            if (y + 1 < SSD1306_HEIGHT) {
                ssd1306_draw_pixel(SSD1306_WIDTH - 1, y + 1, 1);
            }
        }
    }
}

// 绘制带透明度的边框（用于过渡效果）
void draw_border_faded(border_type_t border_type, float intensity) {
    if (intensity <= 0.0f) return;
    
    switch (border_type) {
        case BORDER_DOT:
            draw_dot_border(intensity);
            break;
        case BORDER_SPECTRUM:
            draw_spectrum_border(intensity);
            break;
        case BORDER_NONE:
        default:
            // 无边框
            break;
    }
}

// 统一的动态边框绘制函数（包含平滑过渡）
void draw_dynamic_border_with_transition(void) {
    int64_t current_time = esp_timer_get_time();
    
    // 自动选择目标边框
    target_border = auto_select_border();
    
    // 检查是否需要开始过渡
    if (target_border != current_border && !border_in_transition) {
        previous_border = current_border;
        border_transition_start = current_time;
        border_in_transition = true;
        ESP_LOGI(TAG, "开始边框过渡: %d -> %d", previous_border, target_border);
    }
    
    // 计算过渡进度 (0.0 - 1.0)
    float transition_ratio = 0.0f;
    if (border_in_transition) {
        int64_t elapsed_time = current_time - border_transition_start;
        transition_ratio = (float)elapsed_time / BORDER_TRANSITION_DURATION;
        
        if (transition_ratio >= 1.0f) {
            // 过渡完成
            transition_ratio = 1.0f;
            current_border = target_border;
            border_in_transition = false;
            ESP_LOGI(TAG, "边框过渡完成: %d", current_border);
        }
    } else {
        // 不在过渡中，直接使用当前边框
        transition_ratio = 1.0f;
    }
    
    // 根据过渡状态绘制边框
    if (border_in_transition) {
        // 过渡阶段：同时绘制两种边框
        draw_border_faded(previous_border, 1.0f - transition_ratio); // 旧边框淡出
        draw_border_faded(target_border, transition_ratio); // 新边框淡入
    } else {
        // 稳定阶段：只绘制当前边框
        draw_border_faded(current_border, 1.0f);
    }
}


//显示汉字字符串
void ssd1306_draw_chinese_string(uint8_t x, uint8_t y, int *char_indices, int count, uint8_t color) {
    for (int i = 0; i < count; i++) {
        ssd1306_draw_chinese_char(x + i * 18, y, char_indices[i], color);
    }
}



//菜单显示
void update_music_animation_display(void) {
    ssd1306_clear_screen(0x00);
    int64_t current_time = esp_timer_get_time();
    
    /* 检查菜单超时
    if (menu_mode && !is_playing_song && 
        (current_time - last_menu_action_time > MENU_TIMEOUT)) {
        menu_mode = false;
        current_menu_page = MENU_PAGE_MAIN;
        // 停止所有播放
        stop_sound();
        is_playing_song = false;
        single_note_playing = false;
        note_playing = false;
    }
    */
    // 检查是否需要显示音符名称
    bool show_note = (current_note_display != -1) && 
                    (current_time - note_display_start_time < NOTE_DISPLAY_DURATION);
    
    // 根据当前菜单页面显示不同内容
    switch (current_menu_page) {
        case MENU_PAGE_MAIN:
 
            // 待机状态显示欢迎信息
            // 第一行：显示"欢迎使用！"
            int welcome[] = {0, 1, 2, 3}; // 欢迎使用
            ssd1306_draw_chinese_string(30, 6, welcome, 4, 1);
                
            // 第二行：显示"电子琴酱！"
            int dianziqin[] = {4, 5, 6, 7, 8}; // 电子琴酱！
            ssd1306_draw_chinese_string(25, 26, dianziqin, 5, 1);
            //<—A B—>
            ssd1306_draw_english_char(6, 44, 19 , 1);
            ssd1306_draw_english_char(8, 46, 20 , 1);
            ssd1306_draw_english_char(24, 46, 21 , 1);
            ssd1306_draw_english_char(96, 46, 17 , 1);
            ssd1306_draw_english_char(104, 46, 20 , 1);
            ssd1306_draw_english_char(110, 44, 22 , 1);
            break;
        case MENU_PAGE_YINFU:
            if (show_note) {
                // 显示音符名称
                int note_index = current_note_display;
                if (note_index >= 0 && note_index < 14) {
                    int* note_chars = note_name_english[note_index];
                    if (note_chars[2] == -1) {
                        // 基本音符（两个字母）
                        ssd1306_draw_english_char(48, 26, note_chars[0], 1);
                        ssd1306_draw_english_char(64, 26, note_chars[1], 1);
                    } else {
                        // 带升号的音符（三个字母）
                        ssd1306_draw_english_char(40, 26, note_chars[0], 1);
                        ssd1306_draw_english_char(56, 26, note_chars[1], 1);
                        ssd1306_draw_english_char(72, 26, note_chars[2], 1);
                    }
                }
                
                // 在音符名称上方显示当前音阶
                // 显示 "Base: CX"
                ssd1306_draw_english_char(8, 6, 17, 1);  // B
                ssd1306_draw_english_char(24, 6, 7, 1);  // a
                ssd1306_draw_english_char(40, 6, 8, 1);  // S
                ssd1306_draw_english_char(56, 6, 3, 1);  // e
                ssd1306_draw_english_char(72, 6, 16, 1); // :
                ssd1306_draw_english_char(88, 6, 15, 1); // C
                if (strcmp(current_base_scale, "C3") == 0) {
                    ssd1306_draw_english_char(104, 6, 12, 1); // 显示3
                } 
                else if (strcmp(current_base_scale, "C4") == 0) {
                    ssd1306_draw_english_char(104, 6, 13, 1); // 显示4
                } 
                else if (strcmp(current_base_scale, "C5") == 0) {
                    ssd1306_draw_english_char(104, 6, 14, 1); // 显示5
                }
            
            } else {
                // 待机状态显示欢迎信息
                // 第一行：显示"按住E降调L升调"
                
                ssd1306_draw_chinese_char(0, 6, 27, 1);
                ssd1306_draw_chinese_char(16, 6, 28, 1);
                ssd1306_draw_english_char(40, 6, 18, 1);
                ssd1306_draw_chinese_char(48, 6, 19, 1);
                ssd1306_draw_chinese_char(64, 6, 18, 1);
                ssd1306_draw_english_char(88, 6, 9, 1);
                ssd1306_draw_chinese_char(96, 6, 17, 1);
                ssd1306_draw_chinese_char(112, 6, 18, 1);

                
                // 第二行：显示"触摸键播放音符"
                int dianziqin[] = {20, 21, 22, 23,24,25,26}; // 触摸键播放音符
                ssd1306_draw_chinese_string(2, 26, dianziqin, 7, 1);
                //<—A B—>
                ssd1306_draw_english_char(6, 44, 19 , 1);
                ssd1306_draw_english_char(8, 46, 20 , 1);
                ssd1306_draw_english_char(24, 46, 21 , 1);
                ssd1306_draw_english_char(96, 46, 17 , 1);
                ssd1306_draw_english_char(104, 46, 20 , 1);
                ssd1306_draw_english_char(110, 44, 22 , 1);
                
            }
            
            break;
            
        case MENU_PAGE_TWINKLE:
            // 小星星页面
            // 显示歌曲名称
            int xiaoxingxing_title[] = {9, 10, 10}; // 小星星
            ssd1306_draw_chinese_string(40, 6, xiaoxingxing_title, 3, 1);
            
            
            // 显示播放状态
            if (is_playing_song && current_song_type == 1) {
                
                ssd1306_draw_chinese_char(32, 26, 27, 1);
                ssd1306_draw_english_char(52, 26, 9 , 1);
                ssd1306_draw_chinese_char(64, 26, 29, 1);
                ssd1306_draw_chinese_char(80, 26, 30, 1);
                
                // 显示进度条
                float progress = (float)current_song_index / twinkle_length;
                draw_progress_bar(14, 50, 100, 8, progress);
            } else {
                ssd1306_draw_chinese_char(32, 26, 27, 1);
                ssd1306_draw_english_char(52, 26, 18, 1);
                ssd1306_draw_chinese_char(64, 26, 23, 1);
                ssd1306_draw_chinese_char(80, 26, 24, 1);
                //<—A B—>
                ssd1306_draw_english_char(6, 44, 19 , 1);
                ssd1306_draw_english_char(8, 46, 20 , 1);
                ssd1306_draw_english_char(24, 46, 21 , 1);
                ssd1306_draw_english_char(96, 46, 17 , 1);
                ssd1306_draw_english_char(104, 46, 20 , 1);
                ssd1306_draw_english_char(110, 44, 22 , 1);
                
            }
            break;
            
        case MENU_PAGE_TIANXIA:
            // 天下相亲与相爱页面
            // 显示歌曲名称
            int tianxia_title[] = {11, 12, 13, 14, 15, 13, 16}; // 天下相亲与相爱
            ssd1306_draw_chinese_string(3, 6, tianxia_title, 7, 1);
            
            // 显示播放状态
            if (is_playing_song && current_song_type == 2) {
                ssd1306_draw_chinese_char(32, 26, 27, 1);
                ssd1306_draw_english_char(52, 26, 9 , 1);
                ssd1306_draw_chinese_char(64, 26, 29, 1);
                ssd1306_draw_chinese_char(80, 26, 30, 1);
                
                // 显示进度条
                float progress = (float)current_song_index / tianxia_length;
                draw_progress_bar(14, 50, 100, 8, progress);
            } else {
                ssd1306_draw_chinese_char(32, 26, 27, 1);
                ssd1306_draw_english_char(52, 26, 18, 1);
                ssd1306_draw_chinese_char(64, 26, 23, 1);
                ssd1306_draw_chinese_char(80, 26, 24, 1);
                //<—A B—>
                ssd1306_draw_english_char(6, 44, 19 , 1);
                ssd1306_draw_english_char(8, 46, 20 , 1);
                ssd1306_draw_english_char(24, 46, 21 , 1);
                ssd1306_draw_english_char(96, 46, 17 , 1);
                ssd1306_draw_english_char(104, 46, 20 , 1);
                ssd1306_draw_english_char(110, 44, 22 , 1);
            }
            break;
            
        case MENU_PAGE_BRIGHTNESS:
            // 亮度调节页面
            // 显示标题
            int brightness_title[] = {31, 32, 18, 33}; // 亮度调节
            ssd1306_draw_chinese_string(32, 6, brightness_title, 4, 1);
            
            // 显示亮度条
            draw_progress_bar(14, 23, 100, 8, light_level);
            ssd1306_draw_chinese_char(0, 32, 27, 1);
            ssd1306_draw_chinese_char(16, 32, 12, 1);
            ssd1306_draw_english_char(40, 32, 18, 1);
            ssd1306_draw_chinese_char(48, 32, 34, 1);
            ssd1306_draw_chinese_char(64, 32, 36, 1);
            ssd1306_draw_english_char(88, 32, 9, 1);
            ssd1306_draw_chinese_char(96, 32, 34, 1);
            ssd1306_draw_chinese_char(112, 32, 35, 1);

            //<—A B—>
                ssd1306_draw_english_char(6, 44, 19 , 1);
                ssd1306_draw_english_char(8, 46, 20 , 1);
                ssd1306_draw_english_char(24, 46, 21 , 1);
                ssd1306_draw_english_char(96, 46, 17 , 1);
                ssd1306_draw_english_char(104, 46, 20 , 1);
                ssd1306_draw_english_char(110, 44, 22 , 1);
            break;
            
        case MENU_PAGE_VOLUME:
            // 音量调节页面
            // 显示标题
            int volume_title[] = {25, 37, 18, 33}; // 音量调节
            ssd1306_draw_chinese_string(32, 6, volume_title, 4, 1);
            
            // 显示亮度条
            draw_progress_bar(14, 23, 100, 8, volume_level);
            ssd1306_draw_chinese_char(16, 32, 27, 1);
            ssd1306_draw_chinese_char(32, 32, 12, 1);
            ssd1306_draw_english_char(56, 32, 18, 1);
            ssd1306_draw_chinese_char(64, 32, 19, 1);
            ssd1306_draw_english_char(88, 32, 9, 1);
            ssd1306_draw_chinese_char(96, 32, 17, 1);

            //<—A B—>
                ssd1306_draw_english_char(6, 44, 19 , 1);
                ssd1306_draw_english_char(8, 46, 20 , 1);
                ssd1306_draw_english_char(24, 46, 21 , 1);
                ssd1306_draw_english_char(96, 46, 17 , 1);
                ssd1306_draw_english_char(104, 46, 20 , 1);
                ssd1306_draw_english_char(110, 44, 22 , 1);
            break;
        
        case MENU_PAGE_COLOREGG:
            display_fullscreen_simple(fullscreen_bitmap);
        default:

            break;
        
    }
    draw_dynamic_border_with_transition();
    
    ssd1306_refresh_gram();
    // 绘制漂浮的音符（如果当前有音符在播放）
    draw_floating_notes();
    
    // 刷新显示
    ssd1306_refresh_gram();
    
    // 检查音符显示时间是否结束
    if (show_note && (current_time - note_display_start_time >= NOTE_DISPLAY_DURATION)) {
        current_note_display = -1; // 清除显示
    }
}


//初始化音符动画数组
void init_floating_notes() {
    for (int i = 0; i < MAX_FLOATING_NOTES; i++) {
        floating_notes[i].active = false;
    }
}

//创建新的音符动画
void create_floating_note(int key_num) {
//寻找空闲的动画槽位
    for (int i = 0; i < MAX_FLOATING_NOTES; i++) {
        if (!floating_notes[i].active) {
//随机位置（屏幕底部）
            floating_notes[i].x = (float)(esp_random() % (SSD1306_WIDTH - 8));
            floating_notes[i].y = (float)SSD1306_HEIGHT;
            
//随机速度（2.0-5.0像素/帧）
            floating_notes[i].speed = 2.0f + (esp_random() % 300) / 100.0f;
            
//固定大小（1.0倍）
            floating_notes[i].size = 1.0f;
            
//随机起始帧
            floating_notes[i].frame = esp_random() % 4;
            
            floating_notes[i].start_time = esp_timer_get_time();
            floating_notes[i].active = true;
            
            /*ESP_LOGI(TAG, "创建音符 %d: x=%.1f, y=%.1f, speed=%.1f", 
                    i, floating_notes[i].x, floating_notes[i].y, floating_notes[i].speed);*/
            return;
        }
    }
    //ESP_LOGW(TAG, "无法创建新音符: 已达到最大数量 %d", MAX_FLOATING_NOTES);
}


//更新所有音符动画
void update_floating_notes(void) {
    for (int i = 0; i < MAX_FLOATING_NOTES; i++) {
        if (floating_notes[i].active) {
//更新位置（向上移动）
            floating_notes[i].y -= floating_notes[i].speed;
            
//更新动画帧（每200ms更新一帧）
            int64_t current_time = esp_timer_get_time();
            if (current_time - floating_notes[i].start_time > 200000) {
                floating_notes[i].frame = (floating_notes[i].frame + 1) % 4;
                floating_notes[i].start_time = current_time;
            }
            
//飘出去了就回收
            if (floating_notes[i].y < -8) {
                floating_notes[i].active = false;
                //ESP_LOGI(TAG, "音符 %d 飘出屏幕", i);
            }
        }
    }
}
